<nav class="navbar">
    <div class="container">
        <div class="navbar-content">
            <!-- Logo -->
            <div class="navbar-brand">
                <a href="/" class="logo">
                    <i class="fas fa-shopping-bag"></i>
                    <span>BliMarket</span>
                </a>
            </div>

            <!-- Search Bar -->
            <div class="navbar-search">
                <form action="/" method="GET" class="search-form">
                    <input 
                        type="text" 
                        name="name" 
                        placeholder="Search for products..." 
                        class="search-input"
                        value="{{search.name}}"
                    >
                    <button type="submit" class="search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                </form>
            </div>

            <!-- Nav Links -->
            <div class="navbar-actions">
                {{#if isAuthenticated}}
                    <a href="/cart" class="nav-link cart-link" title="Shopping Cart">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-badge" id="cartBadge">0</span>
                    </a>
                    
                    <div class="dropdown">
                        <button class="nav-link dropdown-toggle" id="userDropdown">
                            <i class="fas fa-user-circle"></i>
                            <span class="user-email">{{user.email}}</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="dropdown-menu" id="userDropdownMenu">
                            <a href="/profile" class="dropdown-item">
                                <i class="fas fa-user"></i>
                                My Profile
                            </a>
                            <a href="/logout" class="dropdown-item" onclick="event.preventDefault(); handleLogout();">
                                <i class="fas fa-sign-out-alt"></i>
                                Logout
                            </a>
                        </div>
                    </div>
                {{else}}
                    <button class="btn btn-outline" onclick="openModal('loginModal')">
                        <i class="fas fa-sign-in-alt"></i>
                        Login
                    </button>
                    <button class="btn btn-primary" onclick="openModal('registerModal')">
                        <i class="fas fa-user-plus"></i>
                        Register
                    </button>
                {{/if}}
            </div>

            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle" id="mobileMenuToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <!-- Mobile Menu -->
        <div class="mobile-menu" id="mobileMenu">
            <div class="mobile-search">
                <form action="/" method="GET" class="search-form">
                    <input 
                        type="text" 
                        name="name" 
                        placeholder="Search for products..." 
                        class="search-input"
                        value="{{search.name}}"
                    >
                    <button type="submit" class="search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                </form>
            </div>
            
            {{#if isAuthenticated}}
                <a href="/cart" class="mobile-menu-item">
                    <i class="fas fa-shopping-cart"></i>
                    Shopping Cart
                </a>
                <a href="/profile" class="mobile-menu-item">
                    <i class="fas fa-user"></i>
                    My Profile
                </a>
                <a href="/logout" class="mobile-menu-item" onclick="event.preventDefault(); handleLogout();">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </a>
            {{else}}
                <a href="#" class="mobile-menu-item" onclick="openModal('loginModal'); return false;">
                    <i class="fas fa-sign-in-alt"></i>
                    Login
                </a>
                <a href="#" class="mobile-menu-item" onclick="openModal('registerModal'); return false;">
                    <i class="fas fa-user-plus"></i>
                    Register
                </a>
            {{/if}}
        </div>
    </div>
</nav>

{{#if isAuthenticated}}
<script>
    // Load cart count on page load
    document.addEventListener('DOMContentLoaded', () => {
        // Use a slight delay to ensure the page is fully loaded
        setTimeout(() => {
            fetch('/cart', {
                method: 'GET',
                credentials: 'include'
            })
            .then(res => {
                // Check if we're on the cart page itself to avoid issues
                if (window.location.pathname === '/cart') {
                    return;
                }
                return res.text();
            })
            .catch(err => {
                console.log('Cart count loading skipped or failed');
            });
        }, 100);
    });
    
    // Logout handler
    async function handleLogout() {
        try {
            const response = await fetch('/api/auth/logout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            });
            
            const data = await response.json();
            
            if (window.showToast) {
                window.showToast('Logged out successfully', 'success');
            }
            
            // Redirect to home page
            setTimeout(() => {
                window.location.href = '/';
            }, 500);
        } catch (error) {
            console.error('Logout error:', error);
            // Still redirect even if API call fails
            window.location.href = '/';
        }
    }
    
    window.handleLogout = handleLogout;
</script>
{{/if}}
