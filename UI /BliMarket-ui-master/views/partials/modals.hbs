<!-- Login Modal -->
<div class="modal" id="loginModal">
    <div class="modal-overlay" onclick="closeModal('loginModal')"></div>
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal('loginModal')">
            <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
            <h2 class="modal-title">Welcome Back</h2>
            <p class="modal-subtitle">Sign in to your account to continue shopping</p>
        </div>
        <form class="auth-form" id="loginForm">
            <div class="form-group">
                <label for="loginEmail" class="form-label">
                    <i class="fas fa-envelope"></i> Email Address
                </label>
                <input type="email" id="loginEmail" name="email" class="form-input" placeholder="Enter your email" required>
                <span class="form-error" id="loginEmailError"></span>
            </div>
            <div class="form-group">
                <label for="loginPassword" class="form-label">
                    <i class="fas fa-lock"></i> Password
                </label>
                <div class="password-input-wrapper">
                    <input type="password" id="loginPassword" name="password" class="form-input" placeholder="Enter your password" required>
                    <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <span class="form-error" id="loginPasswordError"></span>
            </div>
            <div class="form-footer">
                <label class="checkbox-label">
                    <input type="checkbox" name="remember">
                    <span>Remember me</span>
                </label>
                <a href="#" class="link" onclick="openModal('forgotPasswordModal'); closeModal('loginModal'); return false;">Forgot password?</a>
            </div>
            <button type="submit" class="btn btn-primary btn-block" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Sign In
            </button>
            <div class="auth-divider">
                <span>or</span>
            </div>
            <div class="auth-footer">
                <p>Don't have an account? <a href="#" onclick="openModal('registerModal'); closeModal('loginModal'); return false;" class="link">Sign Up</a></p>
            </div>
        </form>
    </div>
</div>

<!-- Register Modal -->
<div class="modal" id="registerModal">
    <div class="modal-overlay" onclick="closeModal('registerModal')"></div>
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal('registerModal')">
            <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
            <h2 class="modal-title">Create Account</h2>
            <p class="modal-subtitle">Join BliMarket and start shopping today</p>
        </div>
        <form class="auth-form" id="registerForm">
            <div class="form-group">
                <label for="registerName" class="form-label">
                    <i class="fas fa-user"></i> Full Name
                </label>
                <input type="text" id="registerName" name="name" class="form-input" placeholder="Enter your full name" minlength="2" maxlength="255" required>
                <span class="form-error" id="registerNameError"></span>
            </div>
            <div class="form-group">
                <label for="registerEmail" class="form-label">
                    <i class="fas fa-envelope"></i> Email Address
                </label>
                <input type="email" id="registerEmail" name="email" class="form-input" placeholder="Enter your email" required>
                <span class="form-error" id="registerEmailError"></span>
            </div>
            <div class="form-group">
                <label for="registerPassword" class="form-label">
                    <i class="fas fa-lock"></i> Password
                </label>
                <div class="password-input-wrapper">
                    <input type="password" id="registerPassword" name="password" class="form-input" placeholder="Create a strong password" minlength="10" required>
                    <button type="button" class="password-toggle" onclick="togglePassword('registerPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <span class="form-error" id="registerPasswordError"></span>
                <div class="password-requirements">
                    <p class="requirements-title">Password must contain:</p>
                    <ul class="requirements-list">
                        <li id="req-length"><i class="fas fa-circle"></i> At least 10 characters</li>
                        <li id="req-uppercase"><i class="fas fa-circle"></i> One uppercase letter</li>
                        <li id="req-lowercase"><i class="fas fa-circle"></i> One lowercase letter</li>
                        <li id="req-digit"><i class="fas fa-circle"></i> One number</li>
                        <li id="req-special"><i class="fas fa-circle"></i> One special character (@$!%*?&)</li>
                    </ul>
                </div>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="terms" id="terms" required>
                    <span>I agree to the <a href="#" class="link">Terms of Service</a> and <a href="#" class="link">Privacy Policy</a></span>
                </label>
                <span class="form-error" id="termsError"></span>
            </div>
            <button type="submit" class="btn btn-primary btn-block" id="registerBtn">
                <i class="fas fa-user-plus"></i> Create Account
            </button>
            <div class="auth-divider">
                <span>or</span>
            </div>
            <div class="auth-footer">
                <p>Already have an account? <a href="#" onclick="openModal('loginModal'); closeModal('registerModal'); return false;" class="link">Sign In</a></p>
            </div>
        </form>
    </div>
</div>

<!-- Forgot Password Modal -->
<div class="modal" id="forgotPasswordModal">
    <div class="modal-overlay" onclick="closeModal('forgotPasswordModal')"></div>
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal('forgotPasswordModal')">
            <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
            <h2 class="modal-title">Reset Password</h2>
            <p class="modal-subtitle" id="forgotPasswordSubtitle">Enter your email to receive a reset token</p>
        </div>
        
        <!-- Step 1: Request Reset Token -->
        <form class="auth-form" id="forgotPasswordForm" style="display: block;">
            <div class="form-group">
                <label for="forgotEmail" class="form-label">
                    <i class="fas fa-envelope"></i> Email Address
                </label>
                <input type="email" id="forgotEmail" name="email" class="form-input" placeholder="Enter your email" required>
                <span class="form-error" id="forgotEmailError"></span>
            </div>
            <button type="submit" class="btn btn-primary btn-block" id="forgotPasswordBtn">
                <i class="fas fa-paper-plane"></i> Send Reset Token
            </button>
            <div class="auth-footer">
                <p>Remember your password? <a href="#" onclick="openModal('loginModal'); closeModal('forgotPasswordModal'); return false;" class="link">Sign In</a></p>
            </div>
        </form>
        
        <!-- Step 2: Reset Password with Token -->
        <form class="auth-form" id="resetPasswordForm" style="display: none;">
            <div class="form-group">
                <label for="resetToken" class="form-label">
                    <i class="fas fa-key"></i> Reset Token
                </label>
                <input type="text" id="resetToken" name="token" class="form-input" placeholder="Enter the token from your email" required>
                <span class="form-error" id="resetTokenError"></span>
            </div>
            <div class="form-group">
                <label for="newPassword" class="form-label">
                    <i class="fas fa-lock"></i> New Password
                </label>
                <div class="password-input-wrapper">
                    <input type="password" id="newPassword" name="newPassword" class="form-input" placeholder="Enter your new password" minlength="10" required>
                    <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <span class="form-error" id="newPasswordError"></span>
            </div>
            <button type="submit" class="btn btn-primary btn-block" id="resetPasswordBtn">
                <i class="fas fa-check"></i> Reset Password
            </button>
            <div class="auth-footer">
                <p><a href="#" onclick="document.getElementById('forgotPasswordForm').style.display='block'; document.getElementById('resetPasswordForm').style.display='none'; document.getElementById('forgotPasswordSubtitle').textContent='Enter your email to receive a reset token'; return false;" class="link">Back to email step</a></p>
            </div>
        </form>
    </div>
</div>

<script>
// Modal functions
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }
}

// Close modal on ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal.active').forEach(modal => {
            modal.classList.remove('active');
            document.body.style.overflow = '';
        });
    }
});

// Password toggle
function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const icon = input.nextElementSibling.querySelector('i');
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Login form handler
document.getElementById('loginForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const btn = document.getElementById('loginBtn');
    
    // Clear errors
    document.querySelectorAll('#loginForm .form-error').forEach(el => el.textContent = '');
    
    if (!email || !password) {
        showToast('Please fill in all fields', 'error');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';
    
    try {
        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
            if (response.ok && data.success) {
                showToast('Login successful! Merging your cart...', 'success');
                
                // Merge guest cart if exists
                const guestCartId = getCookie('guestCartId');
                if (guestCartId) {
                    fetch('/api/v1/cart/merge', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include'
                    })
                    .then(() => {
                        showToast('Cart merged successfully!', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    })
                    .catch(() => {
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    });
                } else {
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            } else {
            showToast(data.message || 'Login failed. Please check your credentials.', 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
        }
    } catch (error) {
        showToast('An error occurred. Please try again.', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
    }
});

// Register form handler
document.getElementById('registerForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const name = document.getElementById('registerName').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const password = document.getElementById('registerPassword').value;
    const terms = document.getElementById('terms').checked;
    const btn = document.getElementById('registerBtn');
    
    // Clear errors
    document.querySelectorAll('#registerForm .form-error').forEach(el => el.textContent = '');
    
    if (!name || !email || !password) {
        showToast('Please fill in all fields', 'error');
        return;
    }
    
    if (!terms) {
        showToast('Please accept the terms and conditions', 'error');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
    
    try {
        const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, password })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showToast('Account created successfully!', 'success');
            setTimeout(() => {
                closeModal('registerModal');
                openModal('loginModal');
            }, 1500);
        } else {
            showToast(data.message || 'Registration failed. Please try again.', 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
        }
    } catch (error) {
        showToast('An error occurred. Please try again.', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
    }
});

// Helper function to get cookie
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

// Password requirements checker
document.getElementById('registerPassword')?.addEventListener('input', function() {
    const password = this.value;
    const requirements = {
        length: { regex: /.{10,}/, element: document.getElementById('req-length') },
        uppercase: { regex: /[A-Z]/, element: document.getElementById('req-uppercase') },
        lowercase: { regex: /[a-z]/, element: document.getElementById('req-lowercase') },
        digit: { regex: /\d/, element: document.getElementById('req-digit') },
        special: { regex: /[@$!%*?&]/, element: document.getElementById('req-special') }
    };
    
    Object.values(requirements).forEach(({ regex, element }) => {
        if (regex.test(password)) {
            element.classList.add('met');
        } else {
            element.classList.remove('met');
        }
    });
});

// Forgot Password Form Handler (Step 1: Request Token)
document.getElementById('forgotPasswordForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const email = document.getElementById('forgotEmail').value.trim();
    const btn = document.getElementById('forgotPasswordBtn');
    const errorEl = document.getElementById('forgotEmailError');
    
    errorEl.textContent = '';
    
    if (!email) {
        errorEl.textContent = 'Email is required';
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    
    try {
        const response = await fetch('/api/auth/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showToast('Reset token sent! Check your email.', 'success');
            // Store token from response
            const resetToken = data.data; // Token is in data.data
            document.getElementById('resetToken').value = resetToken;
            // Show step 2
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('resetPasswordForm').style.display = 'block';
            document.getElementById('forgotPasswordSubtitle').textContent = 'Enter the token and your new password';
        } else {
            showToast(data.message || 'Failed to send reset token. Please try again.', 'error');
            errorEl.textContent = data.message || 'Failed to send reset token';
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Reset Token';
        }
    } catch (error) {
        showToast('An error occurred. Please try again.', 'error');
        errorEl.textContent = 'An error occurred. Please try again.';
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Reset Token';
    }
});

// Reset Password Form Handler (Step 2: Reset with Token)
document.getElementById('resetPasswordForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const token = document.getElementById('resetToken').value.trim();
    const newPassword = document.getElementById('newPassword').value;
    const btn = document.getElementById('resetPasswordBtn');
    const tokenError = document.getElementById('resetTokenError');
    const passwordError = document.getElementById('newPasswordError');
    
    tokenError.textContent = '';
    passwordError.textContent = '';
    
    if (!token) {
        tokenError.textContent = 'Token is required';
        return;
    }
    
    if (!newPassword || newPassword.length < 10) {
        passwordError.textContent = 'Password must be at least 10 characters';
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';
    
    try {
        const response = await fetch('/api/auth/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, newPassword })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showToast('Password reset successfully!', 'success');
            setTimeout(() => {
                closeModal('forgotPasswordModal');
                openModal('loginModal');
            }, 1500);
        } else {
            showToast(data.message || 'Failed to reset password. Please try again.', 'error');
            passwordError.textContent = data.message || 'Failed to reset password';
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check"></i> Reset Password';
        }
    } catch (error) {
        showToast('An error occurred. Please try again.', 'error');
        passwordError.textContent = 'An error occurred. Please try again.';
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check"></i> Reset Password';
    }
});
</script>

